#+TITLE: The Main Module

* The Tangle

#+BEGIN_SRC python :tangle main.py
<<imports>>

<<argument-error>>

<<constants>>

<<enable-debugging>>

<<pipe>>

<<find-files>>

<<main>>
#+END_SRC
* Imports
#+BEGIN_SRC python :noweb-ref imports
# python
import sys
import os

# iperflexer
from iperflexer.argumentparser import Arguments
from iperflexer.iperfparser import IperfParser
from iperflexer.sumparser import SumParser
from iperflexer.unitconverter import UnitNames
from iperflexer.finder import find
#+END_SRC


* Argument Error

#+BEGIN_SRC python :noweb-ref argument-error
class ArgumentError(Exception):
    """
    An error to raise if something is wrong with the arguments
    """
#+END_SRC

* Constants

#+BEGIN_SRC python :noweb-ref constants
UNITS = {'bits': UnitNames.bits,
         'kbits': UnitNames.kbits,
         'mbits': UnitNames.mbits,
         'gbits': UnitNames.gbits,         
         'bytes': UnitNames.bytes,
         'kbytes': UnitNames.kbytes,
         'mbytes': UnitNames.mbytes,
         'gbytes': UnitNames.gbytes}

WRITEABLE = 'w'
ADD_NEWLINE = "{0}\n"
#+END_SRC

* Enable Debugging

#+BEGIN_SRC python :noweb-ref enable-debugging
def enable_debugging():
    try:
        import pudb
        pudb.set_trace()
    except ImportError as error:
        print(error)
        raise ArgumentError("`pudb` argument given but unable to import `pudb`")
#+END_SRC

* Pipe Function

#+BEGIN_SRC python :noweb-ref pipe
def pipe(args, infile=None, outfile=None):
    """
    Reads input from standard in and sends output to standard out.
    """
    if infile is None:
        infile = sys.stdin
    if outfile is None:
        outfile = sys.stdout
    try:
        units = UNITS[args.units.lower()]
    except KeyError:
        raise ArgumentError("Unknown Units: {0}".format(args.units))
        return

    if args.voodoo and not (args.lastlinebandwidth or args.lastlinetransfer):
        parser = IperfParser(units=units,
                             maximum=args.maximum,
                             threads=args.threads)
    else:
        parser = SumParser(units=units, maximum=args.maximum,
                           threads=args.threads)
    for line in infile:
        parser(line)
        if args.tee:
            sys.stderr.write(line)

    if args.lastlinebandwidth:
        # this will only work with the SumParser
        outfile.write(ADD_NEWLINE.format(parser.last_line_bandwidth))
    elif args.lastlinetransfer:
        outfile.write(ADD_NEWLINE.format(parser.last_line_transfer))
    else:
        for bandwidth in parser.bandwidths:
            outfile.write(ADD_NEWLINE.format(bandwidth))
    parser.reset()
    return
#+END_SRC

* Find Files Function

#+BEGIN_SRC python :noweb-ref find-files
def find_files(args):
    """
    Reads data from files and outputs to files
    """
    for name in find(args.glob):
        basename, _ = os.path.splitext(name)
        new_name = basename + "_parsed.csv"
        if args.save:
            output = open(new_name, WRITEABLE)
        else:
            output = None
        pipe(args, open(name), output)
    return
#+END_SRC

* Main

#+BEGIN_SRC python :noweb-ref main
def main():
    args = Arguments().parse_args()
    if args.pudb:
        enable_debugging()
    if args.glob is None:
        pipe(args)
    else:
        find_files(args)
    return
#+END_SRC
